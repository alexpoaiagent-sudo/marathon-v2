#!/bin/bash

# üîç –°–∫—Ä–∏–ø—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ Marathon 2.0
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, –Ω–∞—Ö–æ–¥–∏—Ç –ø—Ä–æ–±–ª–µ–º—ã, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á—ë—Ç

set -e

# –¶–≤–µ—Ç–∞ (–æ—Ç–∫–ª—é—á–∞–µ–º, –µ—Å–ª–∏ –≤—ã–≤–æ–¥ –Ω–µ –≤ TTY –∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω NO_COLOR)
if [ -t 1 ] && [ -z "${NO_COLOR:-}" ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    NC=''
fi

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                                                        ‚ïë"
echo "‚ïë        üîç  Marathon 2.0 - Daily Health Check  üîç      ‚ïë"
echo "‚ïë                                                        ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

# –î–∞—Ç–∞ –æ—Ç—á—ë—Ç–∞
REPORT_DATE=$(date '+%Y-%m-%d')
REPORT_FILE="reports/health-check-${REPORT_DATE}.md"

# –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –¥–ª—è –æ—Ç—á—ë—Ç–æ–≤
mkdir -p reports

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á—ë—Ç—á–∏–∫–æ–≤
TOTAL_CHECKS=0
PASSED_CHECKS=0
WARNINGS=0
ERRORS=0

# –ú–∞—Å—Å–∏–≤—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
declare -a ERROR_MESSAGES
declare -a WARNING_MESSAGES
declare -a INFO_MESSAGES

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
check() {
    local name=$1
    local command=$2
    local error_msg=$3
    
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
    
    if eval "$command" &> /dev/null; then
        echo -e "${GREEN}‚úì${NC} $name"
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
        return 0
    else
        echo -e "${RED}‚úó${NC} $name"
        ERRORS=$((ERRORS + 1))
        ERROR_MESSAGES+=("$error_msg")
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
warn() {
    local name=$1
    local message=$2
    
    echo -e "${YELLOW}‚ö†${NC} $name"
    WARNINGS=$((WARNINGS + 1))
    WARNING_MESSAGES+=("$message")
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
info() {
    local message=$1
    echo -e "${BLUE}‚Ñπ${NC} $message"
    INFO_MESSAGES+=("$message")
}

echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã..."
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
check "README.md —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" "test -f README.md" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≥–ª–∞–≤–Ω—ã–π README.md"
check "DICTIONARY.md —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" "test -f DICTIONARY.md" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å—É—â–Ω–æ—Å—Ç–µ–π"
check "LICENSE —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" "test -f LICENSE" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ñ–∞–π–ª –ª–∏—Ü–µ–Ω–∑–∏–∏"
check "CONTRIBUTING.md —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" "test -f CONTRIBUTING.md" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∫–æ–Ω—Ç—Ä–∏–±—É—Ü–∏–∏"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–ø–æ–∫
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–ø–æ–∫
check "–ü–∞–ø–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã/ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" "test -d –º–∞—Ç–µ—Ä–∏–∞–ª—ã" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–∞–ø–∫–∞ —Å –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏"
check "–ü–∞–ø–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º/ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" "test -d –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –±–ª–æ–∫ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
check "–ü–∞–ø–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º/–≤—Å—Ç—Ä–µ—á–∏/ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" "test -d –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º/–≤—Å—Ç—Ä–µ—á–∏" "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ñ–∞–π–ª—ã –≤—Å—Ç—Ä–µ—á"
check "–ü–∞–ø–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º/—à–∞–±–ª–æ–Ω—ã/ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" "test -d –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º/—à–∞–±–ª–æ–Ω—ã" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–∞–ø–∫–∞ —Å —à–∞–±–ª–æ–Ω–∞–º–∏"
check "–ü–∞–ø–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º/–ø—Ä–∏–º–µ—Ä—ã/ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" "test -d –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º/–ø—Ä–∏–º–µ—Ä—ã" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–∞–ø–∫–∞ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
check "–æ–ø—Ä–æ—Å–Ω–∏–∫.md —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" "test -f –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º/–æ–ø—Ä–æ—Å–Ω–∏–∫.md" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–ø—Ä–æ—Å–Ω–∏–∫"
check "–ø–æ–Ω—è—Ç–∏—è.md —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" "test -f –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º/–ø–æ–Ω—è—Ç–∏—è.md" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ñ–∞–π–ª –ø–æ–Ω—è—Ç–∏–π"
check "–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ-–ø—Ä–∞–∫—Ç–∏–∫–∏.md —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" "test -f –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º/–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ-–ø—Ä–∞–∫—Ç–∏–∫–∏.md" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏–∫"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –≤—Å—Ç—Ä–µ—á
for i in {1..4}; do
    meeting_file="–º–∞—Ç–µ—Ä–∏–∞–ª—ã/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º/–≤—Å—Ç—Ä–µ—á–∏/–≤—Å—Ç—Ä–µ—á–∞-0${i}.md"
    check "–í—Å—Ç—Ä–µ—á–∞ $i —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" "test -f $meeting_file" "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏ $i"
done

echo ""
echo "üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–æ–∫..."
echo ""

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∏—Ç—ã—Ö —Å—Å—ã–ª–æ–∫
check_links() {
    local broken_links=0
    
    # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ .md —Ñ–∞–π–ª—ã
    while IFS= read -r file; do
        # –ò—â–µ–º –≤—Å–µ markdown —Å—Å—ã–ª–∫–∏ –≤–∏–¥–∞ [text](link.md)
        while IFS= read -r link; do
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
            target=$(echo "$link" | sed -E 's/.*\(([^)]+)\).*/\1/')

            # –£–±–∏—Ä–∞–µ–º —è–∫–æ—Ä—è, —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
            target=${target%%#*}

            if [[ -z $target ]]; then
                continue
            fi

            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ —Å—Å—ã–ª–∫–∏
            if [[ "$target" == http* ]] || [[ "$target" == \#* ]]; then
                continue
            fi
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞
            dir=$(dirname "$file")
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å
            full_path="$dir/$target"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ
            if [[ ! -f $full_path && ! -d $full_path ]]; then
                warn "–ë–∏—Ç–∞—è —Å—Å—ã–ª–∫–∞ –≤ $file" "–°—Å—ã–ª–∫–∞ –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª: $target"
                broken_links=$((broken_links + 1))
            fi
        done < <(grep -o '\[.*\]([^)]*)' "$file" 2>/dev/null || true)
    done < <(find . -name "*.md" -type f)
    
    if [ $broken_links -eq 0 ]; then
        info "–í—Å–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Å—ã–ª–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç"
    fi
}

check_links

echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏..."
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
check_states() {
    local states=("–•–∞–æ—Å" "–¢—É–ø–∏–∫" "–ü–æ–≤–æ—Ä–æ—Ç")
    local found_all=true
    
    for state in "${states[@]}"; do
        if ! grep -r "$state" –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º/ &> /dev/null; then
            warn "–°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è" "–°–æ—Å—Ç–æ—è–Ω–∏–µ '$state' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
            found_all=false
        fi
    done
    
    if $found_all; then
        info "–í—Å–µ —Ç—Ä–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–ø–æ–º—è–Ω—É—Ç—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
    fi
}

check_states

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–∞–∫—Ç–∏–∫
check_practices() {
    local practices=("–°–ª–æ—Ç —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏—è" "–ú–∏–º–æ–ª—ë—Ç–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏" "–¢—Ä–µ–∫–µ—Ä-–ø–æ–º–∏–¥–æ—Ä–æ" "–†–∞–±–æ—á–∏–π –ø—Ä–æ–¥—É–∫—Ç" "–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç" "–ú–µ—Ç–æ–¥ —Å—Ç–æ–ø-–º–æ–º–µ–Ω—Ç–∞")
    local found=0
    
    for practice in "${practices[@]}"; do
        if grep -qi "$practice" –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º/–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ-–ø—Ä–∞–∫—Ç–∏–∫–∏.md &> /dev/null; then
            found=$((found + 1))
        fi
    done
    
    if [ $found -eq 6 ]; then
        info "–í—Å–µ 6 –ø—Ä–∞–∫—Ç–∏–∫ –æ–ø–∏—Å–∞–Ω—ã –≤ –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º/–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ-–ø—Ä–∞–∫—Ç–∏–∫–∏.md"
    else
        warn "–ù–µ–ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏–∫" "–ù–∞–π–¥–µ–Ω–æ —Ç–æ–ª—å–∫–æ $found –∏–∑ 6 –ø—Ä–∞–∫—Ç–∏–∫"
    fi
}

check_practices

echo ""
echo "üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
echo ""

# –ü–æ–¥—Å—á—ë—Ç —Ñ–∞–π–ª–æ–≤
total_files=$(find . -name "*.md" -type f | wc -l)
doc_files=$(find –º–∞—Ç–µ—Ä–∏–∞–ª—ã/ -name "*.md" -type f 2>/dev/null | wc -l || echo 0)
example_files=$(find –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—É—á–∞—Å—Ç–Ω–∏–∫–∞–º/–ø—Ä–∏–º–µ—Ä—ã/ -name "*.md" -type f 2>/dev/null | wc -l || echo 0)

info "–í—Å–µ–≥–æ Markdown —Ñ–∞–π–ª–æ–≤: $total_files"
info "–§–∞–π–ª–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: $doc_files"
info "–§–∞–π–ª–æ–≤ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏: $example_files"

# –ü–æ–¥—Å—á—ë—Ç —Å—Ç—Ä–æ–∫
total_lines=$(find . -name "*.md" -type f -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}')
info "–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: $total_lines"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å (–µ—Å–ª–∏ —ç—Ç–æ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π)
if [ -d .git ]; then
    echo ""
    echo "üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞..."
    echo ""
    
    # –ö–æ–º–º–∏—Ç—ã
    commits_count=$(git log --since="24 hours ago" --oneline 2>/dev/null | wc -l || echo 0)
    
    if [ $commits_count -gt 0 ]; then
        info "–ö–æ–º–º–∏—Ç–æ–≤ –∑–∞ 24 —á–∞—Å–∞: $commits_count"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã
        echo ""
        echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:"
        git log --since="24 hours ago" --pretty=format:"  ‚Ä¢ %s (%ar)" --abbrev-commit 2>/dev/null || echo "  –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
        echo ""
    else
        info "–ò–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ –Ω–µ –±—ã–ª–æ"
    fi
    
    # –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    echo ""
    changed_files=$(git diff --name-only HEAD~1 2>/dev/null | wc -l || echo 0)
    if [ $changed_files -gt 0 ]; then
        info "–ò–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º –∫–æ–º–º–∏—Ç–µ: $changed_files"
        git diff --name-only HEAD~1 2>/dev/null | while read file; do
            echo "    ‚Ä¢ $file"
        done
    fi
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    echo ""
    stats=$(git diff --stat HEAD~1 2>/dev/null | tail -1 || echo "")
    if [ ! -z "$stats" ]; then
        info "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: $stats"
    fi
fi

echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""

# –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
echo "üìä –ò–¢–û–ì–û–í–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢"
echo ""
echo "‚úì –£—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫: $PASSED_CHECKS/$TOTAL_CHECKS"
echo "‚ö† –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: $WARNINGS"
echo "‚úó –û—à–∏–±–æ–∫: $ERRORS"
echo ""

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å
if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
    echo -e "${GREEN}üéâ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ –æ—Ç–ª–∏—á–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏!${NC}"
    STATUS="üü¢ –û–¢–õ–ò–ß–ù–û"
elif [ $ERRORS -eq 0 ] && [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ —Ö–æ—Ä–æ—à–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –Ω–æ –µ—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è${NC}"
    STATUS="üü° –•–û–†–û–®–û"
else
    echo -e "${RED}‚ùå –ù–∞–π–¥–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã, —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ${NC}"
    STATUS="üî¥ –¢–†–ï–ë–£–ï–¢ –í–ù–ò–ú–ê–ù–ò–Ø"
fi

echo ""

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Markdown –æ—Ç—á—ë—Ç
echo "üìù –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞..."

cat > "$REPORT_FILE" << 'ENDREPORT'
# üîç –û—Ç—á—ë—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ Marathon 2.0

**–î–∞—Ç–∞:** REPORT_DATE_PLACEHOLDER  
**–°—Ç–∞—Ç—É—Å:** STATUS_PLACEHOLDER

---

## üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–ü—Ä–æ–≤–µ—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:** TOTAL_CHECKS_PLACEHOLDER
- **–£—Å–ø–µ—à–Ω–æ:** PASSED_CHECKS_PLACEHOLDER
- **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π:** WARNINGS_PLACEHOLDER
- **–û—à–∏–±–æ–∫:** ERRORS_PLACEHOLDER

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

- **–í—Å–µ–≥–æ Markdown —Ñ–∞–π–ª–æ–≤:** TOTAL_FILES_PLACEHOLDER
- **–§–∞–π–ª–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** DOC_FILES_PLACEHOLDER
- **–§–∞–π–ª–æ–≤ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏:** EXAMPLE_FILES_PLACEHOLDER
- **–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫:** TOTAL_LINES_PLACEHOLDER

ENDREPORT

# –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
sed -i "s/REPORT_DATE_PLACEHOLDER/$REPORT_DATE/g" "$REPORT_FILE"
sed -i "s/STATUS_PLACEHOLDER/$STATUS/g" "$REPORT_FILE"
sed -i "s/TOTAL_CHECKS_PLACEHOLDER/$TOTAL_CHECKS/g" "$REPORT_FILE"
sed -i "s/PASSED_CHECKS_PLACEHOLDER/$PASSED_CHECKS/g" "$REPORT_FILE"
sed -i "s/WARNINGS_PLACEHOLDER/$WARNINGS/g" "$REPORT_FILE"
sed -i "s/ERRORS_PLACEHOLDER/$ERRORS/g" "$REPORT_FILE"
sed -i "s/TOTAL_FILES_PLACEHOLDER/$total_files/g" "$REPORT_FILE"
sed -i "s/DOC_FILES_PLACEHOLDER/$doc_files/g" "$REPORT_FILE"
sed -i "s/EXAMPLE_FILES_PLACEHOLDER/$example_files/g" "$REPORT_FILE"
sed -i "s/TOTAL_LINES_PLACEHOLDER/$total_lines/g" "$REPORT_FILE"

# –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞ 24 —á–∞—Å–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å Git)
if [ -d .git ] && [ $commits_count -gt 0 ]; then
    cat >> "$REPORT_FILE" << EOF

---

## üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞

**–ö–æ–º–º–∏—Ç–æ–≤:** $commits_count

### –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã:

EOF
    git log --since="24 hours ago" --pretty=format:"- %s (%ar, %an)" --abbrev-commit 2>/dev/null >> "$REPORT_FILE" || true
    echo "" >> "$REPORT_FILE"
    
    if [ $changed_files -gt 0 ]; then
        cat >> "$REPORT_FILE" << EOF

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

EOF
        git diff --name-only HEAD~1 2>/dev/null | while read file; do
            echo "- \`$file\`" >> "$REPORT_FILE"
        done
    fi
fi

# –î–æ–±–∞–≤–ª—è–µ–º –æ—à–∏–±–∫–∏
if [ $ERRORS -gt 0 ]; then
    cat >> "$REPORT_FILE" << EOF

---

## ‚ùå –ù–∞–π–¥–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

EOF
    for error in "${ERROR_MESSAGES[@]}"; do
        echo "- ‚ùå $error" >> "$REPORT_FILE"
    done
fi

# –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
if [ $WARNINGS -gt 0 ]; then
    cat >> "$REPORT_FILE" << EOF

---

## ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

EOF
    for warning in "${WARNING_MESSAGES[@]}"; do
        echo "- ‚ö†Ô∏è $warning" >> "$REPORT_FILE"
    done
fi

# –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
if [ ${#INFO_MESSAGES[@]} -gt 0 ]; then
    cat >> "$REPORT_FILE" << EOF

---

## ‚ÑπÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

EOF
    for info in "${INFO_MESSAGES[@]}"; do
        echo "- ‚ÑπÔ∏è $info" >> "$REPORT_FILE"
    done
fi

# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
cat >> "$REPORT_FILE" << EOF

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

EOF

if [ $ERRORS -gt 0 ]; then
    cat >> "$REPORT_FILE" << EOF
- üî¥ **–ö—Ä–∏—Ç–∏—á–Ω–æ:** –ò—Å–ø—Ä–∞–≤—å—Ç–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –∫–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ
EOF
elif [ $WARNINGS -gt 0 ]; then
    cat >> "$REPORT_FILE" << EOF
- üü° –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∏—Ç—ã–µ —Å—Å—ã–ª–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –∏—Ö
- –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏
EOF
else
    cat >> "$REPORT_FILE" << EOF
- üü¢ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ –æ—Ç–ª–∏—á–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏!
- –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –Ω–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
EOF
fi

# –§—É—Ç–µ—Ä –æ—Ç—á—ë—Ç–∞
cat >> "$REPORT_FILE" << EOF

---

**–û—Ç—á—ë—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω:** $(date '+%Y-%m-%d %H:%M:%S')  
**–°–∫—Ä–∏–ø—Ç:** check-integrity.sh v1.0
EOF

echo -e "${GREEN}‚úì${NC} –û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω: $REPORT_FILE"
echo ""

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–¥ –≤—ã—Ö–æ–¥–∞
if [ $ERRORS -gt 0 ]; then
    exit 1
else
    exit 0
fi
